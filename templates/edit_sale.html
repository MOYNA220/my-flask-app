{% extends "base.html" %}

{% block title %}Edit Sale{% endblock %}
{% block header %}Edit Sale{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Edit Sale #{{ sale.bill_number }}</h2>
        <div>
            <a href="{{ url_for('sales') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </div>
    
    <!-- Customer Selection -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Customer Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label for="customer-select" class="form-label">Select Customer</label>
                    <select class="form-select" id="customer-select">
                        <option value="">Walk-in Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}" {% if sale.customer_id == customer.id %}selected{% endif %}>
                            {{ customer.name }} ({{ customer.mobile }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Search and Selection -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Add Items</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <input type="text" id="item-search" class="form-control" placeholder="Search items...">
            </div>
            
            <div class="table-responsive" style="max-height: 130px; overflow-y: auto;">
    <table id="items-table" class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Stock</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.id }}</td>
                <td>{{ item.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.unit }}</td>
                <td>{{ "%.2f"|format(item.sale_price) }}</td>
                <td>
                    <div class="input-group">
                        <input type="number" class="form-control item-quantity" 
                               value="1" min="1" max="{{ item.quantity }}" 
                               style="width:3px;">
                        <button class="btn btn-primary btn-sm add-to-cart" 
                                data-item-id="{{ item.id }}" 
                                data-item-name="{{ item.name }}" 
                                data-item-unit="{{ item.unit }}"
                                data-item-price="{{ item.sale_price }}"
                                data-item-purchase-price="{{ item.purchase_price }}">
                            Add
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


    <!-- Shopping Cart -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Shopping Cart</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="cart-items" class="table">
                    <thead class="table-dark">
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Unit</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Cart will be rendered dynamically by sales.js -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                            <td id="subtotal">₹{{ "%.2f"|format(sale.total_amount) }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Payment Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Payment</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label"><strong>Payment Method:</strong></label>
                        <select class="form-select" id="payment-method">
                            <option value="Cash" {% if sale.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
                            <option value="Online" {% if sale.payment_method == 'Online' %}selected{% endif %}>Online</option>
                            <option value="Split" {% if sale.payment_method == 'Split' %}selected{% endif %}>Split Payment</option>
                        </select>
                    </div>
                    
                    <div id="cash-section" {% if sale.payment_method != 'Split' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label class="form-label"><strong>Amount Received:</strong></label>
                            <input type="number" class="form-control" id="received-amount" 
                                   min="0" step="0.01" value="{{ sale.received_amount }}">
                        </div>
                    </div>
                    
                    <div id="split-section" {% if sale.payment_method == 'Split' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label class="form-label">Cash Amount</label>
                            <input type="number" class="form-control" id="cash-amount" 
                                   min="0" step="0.01" value="{{ sale.cash_amount }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Online Amount</label>
                            <input type="number" class="form-control" id="online-amount" 
                                   min="0" step="0.01" value="{{ sale.online_amount }}">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Due Amount</label>
                        <input type="text" class="form-control" id="due-amount" 
                                readonly value="{% if sale.received_amount < sale.total_amount %}₹{{ '%.2f'|format(sale.total_amount - sale.received_amount) }}{% else %}₹0.00{% endif %}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Change/Refund</label>
                        <input type="text" class="form-control" id="refund-amount" 
                               readonly value="{% if sale.received_amount > sale.total_amount %}₹{{ '%.2f'|format(sale.received_amount - sale.total_amount) }}{% else %}₹0.00{% endif %}">
                    </div>
                </div>
            </div>
            
          	 <div class="d-flex gap-2 justify-content-center">
    		<button class="btn btn-success" id="update-sale">Update Sale</button>
   		 <button class="btn btn-danger" id="delete-sale">Delete Sale</button>
   		 <a href="{{ url_for('sales') }}" class="btn btn-secondary">Cancel</a>
		</div>
        </div>
    </div>
</div>

<!-- Pass sale data to JS -->
<script>
    window.saleId = {{ sale.id }};
    window.saleItems = [
        {% for item in sale.items %}
        {
            id: {{ item.item_id }},
            item_id: {{ item.item_id }},
            name: "{{ item.item.name if item.item else 'Item #' + item.item_id|string }}",
            quantity: {{ item.quantity }},
            unit: "{{ item.unit }}",
            price: {{ item.sale_price }},
            sale_price: {{ item.sale_price }},
            purchase_price: {{ item.purchase_price }},
            stock: {{ item.item.quantity if item.item else 0 }},
            sale_item_id: {{ item.id }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>

<!-- Include sales.js -->
<script src="{{ url_for('static', filename='js/sales.js') }}"></script>
{% endblock %}
