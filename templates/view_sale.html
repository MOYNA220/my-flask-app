{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section (will be hidden when printing) -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h2>Sale Details</h2>
        <div>
            <a href="{{ url_for('sales') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <a href="{{ url_for('new_sale') }}" class="btn btn-success">
                <i class="fas fa-arrow-left"></i> New Sale
            </a>
            <button class="btn btn-primary ml-2" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>
    
    <!-- Printable Content Section -->
    <div class="printable-content">
        <!-- Invoice Header -->
        <div class="text-center mb-4 print-header">

            <h4 class="mt-3">INVOICE</h4>
        </div>

        <!-- Sale Info Card -->
        <div class="card mb-4 print-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Bill No:</strong> {{ sale.bill_number }}</p>
                        <p class="mb-1"><strong>Date:</strong> {{ sale.sale_date.strftime('%d-%m-%Y') }}</p>
                        <p class="mb-1"><strong>Time:</strong> {{ sale.sale_time }}</p>
                        {% if sale.customer %}
                        <p class="mb-1"><strong>Customer:</strong> {{ sale.customer.name }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6 text-end">
                        <h4>Total: ₹{{ "%.2f"|format(sale.total_amount) }}</h4>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Items Table -->
        <div class="card mb-4 print-card">
            <div class="card-header bg-light print-card-header">
                <h5 class="mb-0">Items Sold</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 print-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Item Name</th>
                                <th class="text-center">Qty</th>
                                <th class="text-center">Unit</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale_item in sale.items %}
                            <tr>
                                <td>{{ sale_item.item.name if sale_item.item else 'Item #' + sale_item.item_id|string }}</td>
                                <td class="text-center">{{ "%.2f"|format(sale_item.quantity) }}</td>
                                <td class="text-center">{{ sale_item.unit }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(sale_item.sale_price) }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(sale_item.quantity * sale_item.sale_price) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4">No items found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Payment Summary -->
        <div class="card print-card">
            <div class="card-body">
                <div class="row justify-content-end">
                    <div class="col-md-4">
                        <table class="table table-sm print-summary-table">
                            <tr>
                                <th>Subtotal:</th>
                                <td class="text-end">₹{{ "%.2f"|format(sale.total_amount) }}</td>
                            </tr>
                            <tr>
                                <th>Amount Paid:</th>
                                <td class="text-end">₹{{ "%.2f"|format(sale.received_amount) }}</td>
                            </tr>
                            <tr class="{{ 'text-danger' if sale.due_amount > 0 else 'text-success' }}">
                                <th>{{ 'Balance Due:' if sale.due_amount > 0 else 'Change:' }}</th>
                                <td class="text-end">₹{{ "%.2f"|format(sale.due_amount if sale.due_amount > 0 else (sale.received_amount - sale.total_amount)) }}</td>
                            </tr>
                            <tr>
                                <th>Payment Method:</th>
                                <td class="text-end">{{ sale.payment_method }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Footer -->
        <div class="text-center mt-4 print-footer">
            <p>Thank you for your business!</p>
            <p class="text-muted">This is a computer generated invoice</p>
        </div>
    </div>
</div>

<style>
    .table th {
        white-space: nowrap;
    }

    @media print {
        body * {
            visibility: hidden;
        }
        .printable-content, .printable-content * {
            visibility: visible;
        }
        .printable-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 15px;
            margin: 0;
        }
        .no-print {
            display: none !important;
        }
        .print-card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            page-break-inside: avoid;
        }
        .print-card-header {
            background-color: #f8f9fa !important;
            color: #000 !important;
        }
        .print-table {
            width: 100% !important;
            border-collapse: collapse !important;
        }
        .print-table th, .print-table td {
            border: 1px solid #ddd !important;
            padding: 8px !important;
        }
        .print-table thead th {
            background-color: #f8f9fa !important;
            color: #000 !important;
        }
        .print-summary-table {
            width: 100% !important;
        }
        .print-header h3 {
            color: #000 !important;
            margin-bottom: 5px;
        }
        .print-header h4 {
            color: #000 !important;
            text-decoration: underline;
        }
        .print-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        @page {
            size: A4;
            margin: 10mm;
        }
        body {
            font-size: 12pt;
            color: #000;
            background: none !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .text-success {
            color: #28a745 !important;
        }
    }
</style>
{% endblock %}